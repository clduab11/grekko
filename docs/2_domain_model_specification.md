# Grekko Trading System - Domain Model Specification

## Document Overview

This document defines the core domain entities, relationships, data structures, and business rules for the Grekko cryptocurrency trading system. It serves as the foundation for system design and implementation.

## 1. Core Domain Entities

### 1.1 Trading Domain

#### Entity: TradingAgent
**Purpose**: Represents an autonomous trading agent within the system.

**Attributes**:
- `agent_id`: UUID - Unique identifier
- `agent_type`: Enum - [AI_ENSEMBLE, SENTIMENT_ANALYZER, TECHNICAL_ANALYZER, ARBITRAGE_HUNTER]
- `status`: Enum - [ACTIVE, INACTIVE, SUSPENDED, MAINTENANCE]
- `performance_metrics`: PerformanceMetrics - Historical performance data
- `risk_tolerance`: RiskProfile - Risk parameters and limits
- `strategies`: List[Strategy] - Associated trading strategies
- `created_at`: DateTime - Agent creation timestamp
- `last_active`: DateTime - Last activity timestamp

**Business Rules**:
- Agent must have valid risk profile before activation
- Performance metrics updated after each trade execution
- Agent can be suspended if performance degrades below threshold
- Maximum 10 active agents per system instance

**State Transitions**:
- INACTIVE → ACTIVE: When agent passes validation and risk checks
- ACTIVE → SUSPENDED: When performance or risk thresholds breached
- SUSPENDED → ACTIVE: When issues resolved and manual approval given
- ANY → MAINTENANCE: For system updates or configuration changes

#### Entity: TradingSignal
**Purpose**: Represents a trading recommendation generated by agents or external sources.

**Attributes**:
- `signal_id`: UUID - Unique identifier
- `source_agent_id`: UUID - Originating agent identifier
- `asset_pair`: AssetPair - Trading pair (e.g., BTC/USD)
- `signal_type`: Enum - [BUY, SELL, HOLD, CLOSE_POSITION]
- `confidence_score`: Float - Signal confidence (0.0-1.0)
- `target_price`: Decimal - Recommended execution price
- `stop_loss`: Decimal - Risk management stop loss
- `take_profit`: Decimal - Profit taking level
- `position_size`: Decimal - Recommended position size
- `expiry_time`: DateTime - Signal expiration
- `metadata`: JSON - Additional signal context
- `created_at`: DateTime - Signal generation time

**Business Rules**:
- Confidence score must be between 0.0 and 1.0
- Signal expires after maximum 5 minutes for high-frequency strategies
- Stop loss must be set for all position-opening signals
- Position size cannot exceed agent's allocated capital

#### Entity: Trade
**Purpose**: Represents an executed trading transaction.

**Attributes**:
- `trade_id`: UUID - Unique identifier
- `order_id`: UUID - Associated order identifier
- `agent_id`: UUID - Executing agent
- `exchange_id`: UUID - Exchange where trade executed
- `asset_pair`: AssetPair - Trading pair
- `trade_type`: Enum - [MARKET, LIMIT, STOP_LOSS, TAKE_PROFIT]
- `side`: Enum - [BUY, SELL]
- `quantity`: Decimal - Trade quantity
- `price`: Decimal - Execution price
- `fees`: Decimal - Trading fees paid
- `status`: Enum - [PENDING, FILLED, PARTIALLY_FILLED, CANCELLED, FAILED]
- `execution_time`: DateTime - Trade execution timestamp
- `settlement_time`: DateTime - Trade settlement timestamp

**Business Rules**:
- Trade must reference valid order and agent
- Execution price must be within acceptable slippage tolerance
- Fees automatically deducted from portfolio balance
- Trade status updated in real-time during execution

### 1.2 Risk Management Domain

#### Entity: RiskProfile
**Purpose**: Defines risk parameters and limits for trading agents and portfolios.

**Attributes**:
- `profile_id`: UUID - Unique identifier
- `max_position_size`: Decimal - Maximum position size per trade
- `max_daily_loss`: Decimal - Maximum daily loss limit
- `max_portfolio_exposure`: Decimal - Maximum portfolio exposure percentage
- `var_limit`: Decimal - Value at Risk limit
- `correlation_limit`: Decimal - Maximum correlation exposure
- `leverage_limit`: Decimal - Maximum leverage allowed
- `asset_concentration_limit`: Decimal - Maximum single asset exposure
- `risk_tolerance`: Enum - [CONSERVATIVE, MODERATE, AGGRESSIVE]
- `created_at`: DateTime - Profile creation time
- `updated_at`: DateTime - Last modification time

**Business Rules**:
- All limits must be positive values
- Portfolio exposure cannot exceed 100%
- Risk tolerance determines default parameter ranges
- Profile changes require risk manager approval

#### Entity: RiskEvent
**Purpose**: Represents risk-related events and violations.

**Attributes**:
- `event_id`: UUID - Unique identifier
- `event_type`: Enum - [LIMIT_BREACH, CIRCUIT_BREAKER, CORRELATION_SPIKE, VAR_EXCEEDED]
- `severity`: Enum - [LOW, MEDIUM, HIGH, CRITICAL]
- `affected_entity_id`: UUID - Entity affected by risk event
- `description`: String - Human-readable description
- `risk_metrics`: JSON - Relevant risk metrics at time of event
- `action_taken`: Enum - [ALERT_ONLY, POSITION_REDUCED, TRADING_HALTED, MANUAL_INTERVENTION]
- `resolved`: Boolean - Whether event has been resolved
- `created_at`: DateTime - Event occurrence time
- `resolved_at`: DateTime - Event resolution time

**Business Rules**:
- Critical events automatically halt trading
- High severity events require immediate attention
- All events must be acknowledged within 15 minutes
- Resolution requires risk manager approval

### 1.3 Market Data Domain

#### Entity: MarketData
**Purpose**: Represents real-time and historical market data.

**Attributes**:
- `data_id`: UUID - Unique identifier
- `source`: Enum - [COINBASE, BINANCE, UNISWAP, SUSHISWAP, NEWS_API, TWITTER]
- `asset_pair`: AssetPair - Trading pair
- `data_type`: Enum - [PRICE, VOLUME, ORDER_BOOK, TRADE, SENTIMENT, NEWS]
- `timestamp`: DateTime - Data timestamp
- `price`: Decimal - Asset price (if applicable)
- `volume`: Decimal - Trading volume (if applicable)
- `bid`: Decimal - Best bid price (if applicable)
- `ask`: Decimal - Best ask price (if applicable)
- `metadata`: JSON - Additional data fields
- `quality_score`: Float - Data quality indicator (0.0-1.0)

**Business Rules**:
- Data must be timestamped with microsecond precision
- Stale data (>5 seconds old) flagged for high-frequency strategies
- Quality score based on source reliability and data consistency
- Duplicate data points automatically filtered

#### Entity: SentimentData
**Purpose**: Represents social sentiment analysis results.

**Attributes**:
- `sentiment_id`: UUID - Unique identifier
- `source`: Enum - [TWITTER, REDDIT, TELEGRAM, NEWS, INFLUENCER]
- `asset`: String - Asset symbol or name
- `sentiment_score`: Float - Sentiment score (-1.0 to 1.0)
- `confidence`: Float - Analysis confidence (0.0-1.0)
- `volume`: Integer - Number of mentions/posts analyzed
- `keywords`: List[String] - Key terms driving sentiment
- `influencer_impact`: Float - Weighted impact of key influencers
- `timestamp`: DateTime - Analysis timestamp
- `raw_data_sample`: JSON - Sample of raw data analyzed

**Business Rules**:
- Sentiment score normalized between -1.0 (very negative) and 1.0 (very positive)
- Minimum 10 data points required for reliable sentiment calculation
- Influencer posts weighted higher than general public
- Sentiment data expires after 1 hour for real-time strategies

### 1.4 Portfolio Management Domain

#### Entity: Portfolio
**Purpose**: Represents a trading portfolio with positions and balances.

**Attributes**:
- `portfolio_id`: UUID - Unique identifier
- `owner_id`: UUID - Portfolio owner (agent or user)
- `base_currency`: String - Portfolio base currency
- `total_value`: Decimal - Current portfolio value
- `available_balance`: Decimal - Available trading balance
- `positions`: List[Position] - Current positions
- `performance_metrics`: PerformanceMetrics - Portfolio performance
- `risk_metrics`: RiskMetrics - Current risk exposure
- `created_at`: DateTime - Portfolio creation time
- `last_updated`: DateTime - Last update timestamp

**Business Rules**:
- Total value updated in real-time with market movements
- Available balance cannot go negative
- Position sizes must sum to total allocated capital
- Performance calculated using time-weighted returns

#### Entity: Position
**Purpose**: Represents a trading position in a specific asset.

**Attributes**:
- `position_id`: UUID - Unique identifier
- `portfolio_id`: UUID - Parent portfolio
- `asset`: String - Asset symbol
- `quantity`: Decimal - Position quantity
- `average_price`: Decimal - Average entry price
- `current_price`: Decimal - Current market price
- `unrealized_pnl`: Decimal - Unrealized profit/loss
- `realized_pnl`: Decimal - Realized profit/loss
- `position_type`: Enum - [LONG, SHORT]
- `entry_time`: DateTime - Position entry time
- `last_updated`: DateTime - Last price update

**Business Rules**:
- Quantity must be non-zero for active positions
- Unrealized P&L calculated using current market price
- Position automatically closed when quantity reaches zero
- Average price updated with each additional trade

### 1.5 Exchange Integration Domain

#### Entity: Exchange
**Purpose**: Represents a cryptocurrency exchange integration.

**Attributes**:
- `exchange_id`: UUID - Unique identifier
- `name`: String - Exchange name
- `type`: Enum - [CEX, DEX] - Centralized or Decentralized
- `api_endpoint`: String - API base URL
- `websocket_endpoint`: String - WebSocket feed URL
- `supported_pairs`: List[AssetPair] - Supported trading pairs
- `fee_structure`: FeeStructure - Trading fee information
- `rate_limits`: RateLimits - API rate limiting rules
- `status`: Enum - [ACTIVE, MAINTENANCE, DISABLED]
- `last_health_check`: DateTime - Last connectivity check

**Business Rules**:
- Exchange must pass health check before activation
- Rate limits strictly enforced to prevent API bans
- Fee structure updated daily from exchange APIs
- Maintenance mode disables new order placement

#### Entity: ExchangeAccount
**Purpose**: Represents an account on a specific exchange.

**Attributes**:
- `account_id`: UUID - Unique identifier
- `exchange_id`: UUID - Associated exchange
- `api_key_id`: UUID - Reference to encrypted API credentials
- `account_type`: Enum - [SPOT, MARGIN, FUTURES]
- `balances`: List[Balance] - Account balances by asset
- `permissions`: List[String] - API permissions granted
- `status`: Enum - [ACTIVE, SUSPENDED, EXPIRED]
- `last_sync`: DateTime - Last balance synchronization

**Business Rules**:
- API credentials encrypted and stored securely
- Balances synchronized every 30 seconds
- Suspended accounts cannot place new orders
- Permissions validated before each API call

## 2. Value Objects

### 2.1 AssetPair
**Purpose**: Represents a trading pair (base/quote currency).

**Attributes**:
- `base_asset`: String - Base currency symbol
- `quote_asset`: String - Quote currency symbol
- `symbol`: String - Combined symbol (e.g., "BTC/USD")

**Validation Rules**:
- Both base and quote assets must be valid symbols
- Symbol format must follow exchange conventions
- Case-insensitive comparison for equality

### 2.2 PerformanceMetrics
**Purpose**: Encapsulates performance calculation results.

**Attributes**:
- `total_return`: Decimal - Total return percentage
- `sharpe_ratio`: Decimal - Risk-adjusted return metric
- `max_drawdown`: Decimal - Maximum drawdown percentage
- `win_rate`: Decimal - Percentage of profitable trades
- `profit_factor`: Decimal - Gross profit / gross loss ratio
- `average_trade_duration`: Duration - Average holding period
- `total_trades`: Integer - Total number of trades
- `calculation_period`: DateRange - Period for calculations

### 2.3 RiskMetrics
**Purpose**: Encapsulates risk calculation results.

**Attributes**:
- `value_at_risk`: Decimal - VaR at 95% confidence
- `expected_shortfall`: Decimal - Expected loss beyond VaR
- `beta`: Decimal - Market correlation coefficient
- `volatility`: Decimal - Portfolio volatility
- `correlation_matrix`: Matrix - Asset correlation matrix
- `concentration_risk`: Decimal - Single asset concentration
- `leverage_ratio`: Decimal - Current leverage utilization

## 3. Domain Services

### 3.1 TradingOrchestrator
**Purpose**: Coordinates trading decisions across multiple agents.

**Responsibilities**:
- Aggregate signals from multiple agents
- Resolve conflicting trading signals
- Enforce portfolio-level constraints
- Coordinate order execution timing
- Monitor agent performance and health

**Key Methods**:
- `aggregate_signals(signals: List[TradingSignal]) -> ConsolidatedSignal`
- `resolve_conflicts(conflicting_signals: List[TradingSignal]) -> TradingDecision`
- `validate_constraints(decision: TradingDecision) -> ValidationResult`
- `execute_decision(decision: TradingDecision) -> ExecutionResult`

### 3.2 RiskManager
**Purpose**: Manages risk assessment and mitigation across the system.

**Responsibilities**:
- Calculate real-time risk metrics
- Monitor risk limit violations
- Trigger circuit breakers when necessary
- Generate risk reports and alerts
- Approve risk profile changes

**Key Methods**:
- `calculate_portfolio_risk(portfolio: Portfolio) -> RiskMetrics`
- `check_risk_limits(metrics: RiskMetrics, limits: RiskProfile) -> List[RiskViolation]`
- `trigger_circuit_breaker(event: RiskEvent) -> CircuitBreakerAction`
- `generate_risk_report(portfolio: Portfolio, period: DateRange) -> RiskReport`

### 3.3 MarketDataAggregator
**Purpose**: Aggregates and normalizes market data from multiple sources.

**Responsibilities**:
- Collect data from multiple exchanges and sources
- Normalize data formats and timestamps
- Detect and handle data quality issues
- Provide unified market data interface
- Cache frequently accessed data

**Key Methods**:
- `aggregate_price_data(asset_pair: AssetPair) -> AggregatedPrice`
- `normalize_data_format(raw_data: RawMarketData) -> MarketData`
- `validate_data_quality(data: MarketData) -> QualityScore`
- `get_best_price(asset_pair: AssetPair, side: OrderSide) -> Price`

## 4. Domain Events

### 4.1 Trading Events

#### TradeExecuted
**Triggered**: When a trade is successfully executed
**Payload**:
- `trade_id`: UUID
- `agent_id`: UUID
- `asset_pair`: AssetPair
- `quantity`: Decimal
- `price`: Decimal
- `execution_time`: DateTime

#### SignalGenerated
**Triggered**: When a trading agent generates a new signal
**Payload**:
- `signal_id`: UUID
- `agent_id`: UUID
- `signal_type`: SignalType
- `confidence_score`: Float
- `asset_pair`: AssetPair

### 4.2 Risk Events

#### RiskLimitBreached
**Triggered**: When a risk limit is exceeded
**Payload**:
- `limit_type`: RiskLimitType
- `current_value`: Decimal
- `limit_value`: Decimal
- `affected_entity_id`: UUID
- `severity`: RiskSeverity

#### CircuitBreakerTriggered
**Triggered**: When circuit breaker halts trading
**Payload**:
- `trigger_reason`: String
- `affected_agents`: List[UUID]
- `trigger_time`: DateTime
- `estimated_resume_time`: DateTime

### 4.3 Market Events

#### PriceAlert
**Triggered**: When asset price crosses significant threshold
**Payload**:
- `asset_pair`: AssetPair
- `current_price`: Decimal
- `threshold_price`: Decimal
- `direction`: PriceDirection
- `timestamp`: DateTime

#### VolatilitySpike
**Triggered**: When market volatility exceeds normal ranges
**Payload**:
- `asset_pair`: AssetPair
- `current_volatility`: Decimal
- `normal_range`: VolatilityRange
- `spike_magnitude`: Decimal

## 5. Aggregate Boundaries

### 5.1 Trading Aggregate
**Root Entity**: TradingAgent
**Entities**: TradingSignal, Trade, Strategy
**Invariants**:
- Agent must be active to generate signals
- Signals must not exceed agent's risk limits
- Trades must reference valid signals

### 5.2 Portfolio Aggregate
**Root Entity**: Portfolio
**Entities**: Position, Balance, Transaction
**Invariants**:
- Total position values cannot exceed portfolio value
- Available balance must be non-negative
- Position quantities must be accurate

### 5.3 Risk Aggregate
**Root Entity**: RiskProfile
**Entities**: RiskEvent, RiskMetrics, RiskLimit
**Invariants**:
- Risk limits must be consistent and achievable
- Risk events must be properly categorized
- Metrics must be calculated using current data

## 6. Data Consistency Rules

### 6.1 Eventual Consistency
- Market data synchronization across exchanges
- Portfolio balance updates from multiple sources
- Performance metric calculations
- Sentiment analysis aggregation

### 6.2 Strong Consistency
- Trading order placement and execution
- Risk limit enforcement
- Account balance modifications
- Credential management operations

### 6.3 Compensation Patterns
- Failed trade execution rollback
- Risk limit breach recovery
- Data corruption detection and repair
- System failure recovery procedures

## 7. Domain Glossary

**Agent**: Autonomous trading entity with specific strategies and risk parameters
**Alpha**: Excess return generated above market benchmark
**Arbitrage**: Profit from price differences across exchanges or markets
**Circuit Breaker**: Automated mechanism to halt trading during adverse conditions
**Correlation**: Statistical relationship between asset price movements
**Drawdown**: Peak-to-trough decline in portfolio value
**Ensemble**: Multiple AI models working together for decision making
**Liquidity**: Ease of buying/selling an asset without affecting price
**Position**: Holding of a specific asset in a portfolio
**Sentiment**: Market participant emotions and opinions about assets
**Sharpe Ratio**: Risk-adjusted return metric
**Slippage**: Difference between expected and actual execution price
**Volatility**: Measure of price variation over time
**VaR**: Value at Risk - potential loss at given confidence level

---

**Document Version**: 1.0  
**Last Updated**: 2025-05-29  
**Review Date**: 2025-06-29  
**Approved By**: Domain Architecture Team